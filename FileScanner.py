import mimetypes
from zipfile import ZipFile
import tkinter as tk
from tkinter import ttk
from tkinter import filedialog as fd
from tkinter.messagebox import showinfo
import re

target_pattern = re.compile("\/.*?\.[\w:]+")

# create the root window
root = tk.Tk()
root.title('FileScanner: Scan office documents for malicious content')
root.resizable(False, False)
root.geometry('640x500')
detectors = ['mhtml','mshta','wscript','Private Sub','Dim','End Sub','cmd','CMD','vbscript','ActiveCell','End If','CDATA','bin','oleObject','OLE Package','shell','powershell','Shell','cscript','Cscript',
'PowerShell','ISE','Auto_Open','Workbooks.Open','.00F','.2Q0','.2QM','.MF','.ACC','.ACCDA','.ACCDE','.ACCDT','.ACCDU','.ACCFL','.ACCFT','.ACCTB','.ACG','.ACL','.ACM','.ACS','.ADC','.ADM','.ADML','.ADMX',
'.ADP','.AIO','.AM','.AMX','.ANI','.AODL','.APL','.APM','.APPCACHE','.APPX','.ART','.ASCX','.ASD','.ASP','.ASPX','.AUTOMATICDESTINATIONS-MS','.AUX','.AVI','.AW','.AX','.BAG','.BAK','.BAT','.BCF','.BCM',
'.BDR','.BEP','.BIN','.BIT','.BLB','.BLF','.BR2','.BROWSER','.BRUSH','.BTL','.BTR','.BUD','.BXF','.CAB','.CACHE','.CAG','.CAMP','.CAP','.CDMP','.CDP','.CDR','.CER','.CFG','.CGM','.CHK','.CHM','.CHQ','.CHR',
'.CHS','.CHT','.CI','.CLB','.CLS','.CMB','.CMD','.CMF','.CMS','.CNT','.CNV','.COMMENTS','.COMPOSITEFONT','.CONF','.CONFIG','.CONTACT','.COV','.CPA','.CPF','.CPI','.CPL','.CPX','.CRMLOG','.CRT','.CRWL','.CS',
'.CSD','.CSG','.CSO','.CSV','.CTG','.CTY','.CUR','.CUSTOMDESTINATIONS-MS','.CW','.CWL','.DAT','.DATA','.DB-SHM','.DB-WAL','.DB','.DBF','.DBL','.DCP','.DCT','.DDS','.DEFAULT','.DEP','.DESKLINK','.DEU','.DGML',
'.DHS','.DIA','.DIAGPKG','.DIB','.DIC','.DIR','.DIT','.DLG','.DLL','.DLM','.DLS','.DOC','.DOT','.DOTX','.DPB','.DPC','.DPV','.DPX','.DRV','.DS','.DTD','.DUN','.DXT','.DYC','.EBD','.ECF','.EDB','.EFI','.EFTX',
'.ELM','.EMF','.ENG','.ENU','.ENV','.EPS','.ESN','.ETL','.EV1','.EV2','.EV','.EVM','.EVT','.EVTX','.EXC','.EXE','.EXP','.FAE','.FDT','.FE','.FEED-MS','.FEEDSDB-MS','.FIL','.FLT','.FMT','.FNT','.FON','.FOT','.FPR',
'.FPX','.FRA','.FRM','.FT','.FTG','.FTS','.FX','.FXH','.FXO','.GDL','.GID','.GMMP','.GPD','.GRA','.GRL','.GRM','.GRXML','.GST','.GTA','.GTHR','.GZ','.H1C','.H1D','.H1H','.H1K','.H1S','.H1T','.H1W','.H264','.H',
'.HTA','.HASH','.HCP','.HDR','.HEQ','.HEX','.HHK','.HIT','.HKF','.HLP','.HLX','.HOL','.HPI','.HTA','.HTC','.HTM','.HTML','.HTT','.HTX','.HVE','.HXC','.HXD','.HXH','.HXK','.HXL','.HXN','.HXS','.HXT','.HXW','.HXX',
'.ICM','.ICW','.ID','.IDL','.IDX','.IDX_DLL','.IEC','.IEM','.IMD','.IME','.INBOX','.INC','.IND','.INDEX','.INF','.INI','.INS','.IQY','.ISP','.ITA','.ITEMDATA-MS','.ITS','.JCP','.JFM','.JNT','.JPN','.JRS','.JS1',
'.JS','.JSON','.JSP','.JTP','.JTX','.KIC','.KOR','.LCK','.LDF','.LEX','.LIBRARY-MS','.LKG','.LM','.LNG','.LNK','.LOCK','.LOG1','.LOG2','.LOG','.LO_','.LST','.LTS','.LUA','.LXA','.M4A','.MAP','.MAPIMAIL','.MAPSTYLE',
'.MAR','.MASTER','.MCC','.MCXML','.MD','.MDA','.MDB','.MDE','.MDL','.MDT','.MDW','.MDZ','.METADATA','.MFL','.MHT','.MIB','.MID','.MKD','.MLLR','.MMF','.MML','.MMW','.MNI','.MOD','.MODEL','.MOF','.MP','.MSC','.MSG',
'.MSHC','.MSHI','.MSI','.MSO','.MSP','.MSS','.MSSTYLES','.MST','.MSU','.MTL','.MUI','.MYDOCS','.NEW','.NGR','.NLD','.NLP','.NLS','.NLT','.NNM','.NRR','.NSC','.NT','.NTF','.NU2','.NUS','.NUSPEC','.OBD','.OBE','.OBJ',
'.OBT','.OCX','.ODC','.ODF','.OFT','.OLB','.OLD','.ONE','.ONEPKG','.ONT','.OPG','.OPS','.OPT','.ORP','.OT','.OUT','.OVERRIDETASKS','.P7B','.P7X','.PAT','.PBK','.PCS','.PCT','.PCX','.PEN','.PERF','.PF','.PHN','.PIF',
'.PIP','.PM2','.PM','.PNF','.PNG','.POC','.POLICY','.POT','.POTX','.PPA','.PPD','.PPKG','.PPT','.PPTX','.PRI','.PRM','.PRO','.PROFILE','.PROPDESC','.PROPS','.PRT','.PRX','.PS1','.PS1XML','.PS','.PSD1','.PSM1','.PSP',
'.PTXML','.PUB','.QML','.QUE','.RAD','.RAM','.RAT','.RAW','.RBF','.RBS','.RDLC','.REG','.RESJSON','.RESP','.RESW','.RLD','.RLL','.ROM','.RPO','.RS','.RSP','.RSRC','.SAM','.SAV','.SCF','.SCH','.SCHEMA','.SCM','.SCP',
'.SCR','.SDB','.SDF','.SDI','.SEARCH-MS','.SEARCHCONNECTOR-MS','.SEP','.SES','.SETTING','.SETTINGCONTENT-MS','.SHP','.SHW','.SIG','.SLL','.SMP','.SPA','.SPD','.SQL','.SQLITE','.SQM','.SRD-SHM','.SRD-WAL','.SRD',
'.SST','.STF','.STL','.STORE','.STP','.SVE','.SWF','.SWIDTAG','.SYS','.TAB','.TABLE','.TARGETS','.TASKS','.TBL','.TBR','.TDAT','.TDF','.THA','.THEME','.THMX','.TIF','.TILE','.TLB','.TME','.TMF','.TMP','.TNU','.TOC',
'.TON','.TRE','.TRM','.TSK','.TSP','.TTC','.TTF','.TTS','.TXT','.UCA','.UCE','.UDT','.UNI','.UNINSTALL','.UNT','.URL','.VBS','.VBX','.VCH','.VDF','.VDM','.VEC','.VER','.VOL','.VP','.VPOL','.VRG','.VS','.VSCH',
'.VSDIR','.VXD','.W2B','.WB2','.WBF','.WDF','.WER','.WID','.WIH','.WIM','.WINMD','.WIZ','.WK4','.WLL','.WMDB','.WMZ','.WOFF','.WPC','.WPD','.WPG','.WPL','.WPRP','.WRC','.WSB','.WSC','.WSF','.WTL','.WTS','.WVE',
'.WWD','.XAML','.XAP','.XBAP','.XBF','.XDR','.XIN','.XLA','.XLAM','.XLL','.XLS','.XLSX','.XLT','.XLTX','.XML','.XPB','.XRM-MS','.XSD','.XSL','.XSLT','.XSN','.XSS','.XST','.XSX','.YES','.ZFSENDTOTARGET','.ZIP',
'.acm','.ad','.ade','.adp','.air','.app','.application','.appref-ms','.arc','.arj','.asa','.asp','.aspx','.asx','.ax','.bas','.bat','.bz2','.bz','.cab','.cer','.cfg','.chi','.chm','.class','.clb','.cmd','.cnt',
'.cnv','.command','.cpl','.cpx','.crt','.crx','.csh','.der','.desklink','.desktop','.dll','.drv','.exe','.fdf','.fxp','.gadget','.glk','.grp','.gz','.hex','.hlp','.hqx','.hta','.htt','.ime','.inf','.ini',
'.ins','.isp','.its','.jar','.jnlp','.job','.js','.jse','.ksh','.library-ms','.lnk','.local','.lzh','.mad','.maf','.mag','.mam','.manifest','.mapimail','.maq','.mar','.mas','.mat','.mau','.mav','.maw','.mda',
'.mdb','.mde','.mdt','.mdw','.mdz','.mmc','.mof','.msc','.msh1','.msh1xml','.msh2','.msh2xml','.msh','.mshxml','.msi','.msp','.mst','.mui','.mydocs','.nls','.ocx','.ops','.pcd','.perl','.pi','.pif','.pkg','.pl',
'.plg','.prf','.prg','.ps1','.ps1xml','.ps2','.ps2xml','.psc1','.psc2','.pst','.py','.pyc','.pyd','.pyo','.rar','.rb','.reg','.scf','.scr','.sct','.sea','.search-ms','.searchConnector-ms','.shb','.shs','.sit',
'.sys','.tar','.taz','.term','.tgz','.tlb','.tmp','.tool','.tsp','.url','.vb','.vbe','.vbs','.vsmacros','.vss','.vst','.vsw','.vxd','.webloc','.website','.ws','.wsc','.wsf','.wsh','.xbap','.xnk','.xpi','.z',
'.zfsendtotarget','.zip','.zlo','.zoo']

class File_Scanner():
    def attack_detected(line,item):
        if len(line)> 10000:
            pass
        else:
            global output, target_pattern
            attack_line = target_pattern.findall(line)
            if "bin" or "Target=" or "ps1" or "exe" or ".hta" or "wscript" or "cscript" or "IEX" in attack_line:
                output = (('POSSIBLE ATTACK DETECTED {}').format(str(item))+'\n\n' + str(attack_line))
            print(line.replace('\\','/'))
            line = ''
            return output


    def office_doc_scan(input_file):
        global detectors
        with ZipFile(input_file, 'r') as archive:
            files = archive.namelist()
            for file in files:
                content = archive.open(file)
                line = archive.read(content.name)
                line = str(line)
                for item in detectors:
                    if item in line:
                        File_Scanner.attack_detected(line=line,item=item)
                    else:
                        pass
    
    def file_handler(file):
        with open(file) as f:
            lines = f.readlines()
            for line in lines:
                for detector in detectors:
                    if detectors in line:
                        output = (('POSSIBLE ATTACK DETECTED {}').format(str(detector))+'\n\n' + str(line))

class File_detector:


    def detect_filetype(file):
        global mime_type
        mime_type = mimetypes.guess_type(file)[0]
        return mime_type


def select_files():
    global output
    filetypes = (
        ('Text Files','*.txt'),
        ('All files', '*.*')
    )


    office_mimetypes = ['application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document','application/vnd.openxmlformats-officedocument.wordprocessingml.template',
    'application/vnd.ms-word.document.macroEnabled.12','application/vnd.ms-word.template.macroEnabled.12','application/msexcel','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    'application/msexcel','application/vnd.openxmlformats-officedocument.spreadsheetml.template','application/vnd.ms-excel.sheet.macroEnabled.12','application/vnd.ms-excel.sheet.binary.macroEnabled.12']
    
    pdf_mimetypes = ['application/pdf','application/x-pdf']
    rtf_controlwords = ['4d5a','rtf1','0105000002000000','Equation','cmd','appdata','tmp','startup','reg add','powershell','PowerShell','system','%USERPROFILE%','Msxml2','SAXXMLReader','mbarPr','mbaseJc','mbegChr','mboderBoxPr','mbox','mboxPr','mchr','mcount','mctrlPr']
    filenames = fd.askopenfilenames(
        title='Open files',
        initialdir='/',
        filetypes=filetypes)
    for file in filenames:
        File_detector.detect_filetype(file=file)
        if mime_type in office_mimetypes:
            File_Scanner.office_doc_scan(input_file=file)
        elif mime_type in pdf_mimetypes:
            pass
        else:
            pass

        showinfo(
            title='Selected Files',
                message=filenames
        )
        showinfo(
            title='Document Mimetype',
            message=(mime_type)
        )
        try:
            if output:
                showinfo(
                    title='Possible Attacks Detected in the following lines',
                    message=(output)
                )
        except:
            pass


open_button = ttk.Button(
    root,
    text='Open Files',
    command=select_files
)

open_button.pack(expand=True)

root.mainloop()
